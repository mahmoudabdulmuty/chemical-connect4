<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chemical Connect 4 | Chemistry Game</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        /* Dark Background: Deep Slate Blue/Black */
        background: #0f172a;
        color: #e2e8f0; /* Light gray text for readability */
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        touch-action: manipulation;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container {
        /* Dark Container */
        background: #1e293b;
        border-radius: 20px;
        padding: 30px;
        /* darker shadow */
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        max-width: 1400px;
        width: 100%;
        border: 1px solid #334155;
      }

      h1 {
        text-align: center;
        /* Glowing Purple/Blue text */
        color: #818cf8;
        margin-bottom: 10px;
        font-size: 2.5em;
        text-shadow: 0 0 10px rgba(129, 140, 248, 0.3);
      }

      .subtitle {
        text-align: center;
        color: #94a3b8;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .setup-screen {
        text-align: center;
      }

      .player-count {
        margin-bottom: 30px;
      }

      .player-count label {
        font-size: 1.2em;
        color: #e2e8f0;
        margin-right: 10px;
      }

      .player-count select {
        padding: 10px 20px;
        font-size: 1.1em;
        background: #334155;
        color: white;
        border: 2px solid #6366f1;
        border-radius: 10px;
        cursor: pointer;
      }

      .players-config {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 30px;
      }

      .player-card {
        background: #334155;
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #475569;
        min-width: 200px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .player-card h3 {
        margin-bottom: 15px;
        color: #e2e8f0;
      }

      .player-name-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        background: #1e293b;
        color: white;
        border: 2px solid #6366f1;
        border-radius: 8px;
        font-size: 1em;
      }

      .color-options {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .color-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid #1e293b;
        cursor: pointer;
        transition: all 0.3s;
      }

      .color-btn:hover {
        transform: scale(1.1);
      }

      .color-btn.selected {
        border: 3px solid #e2e8f0;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      /* Darker, cooler buttons */
      .start-btn,
      .edit-questions-btn {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.2em;
        border-radius: 50px;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
      }

      .edit-questions-btn {
        background: linear-gradient(135deg, #d97706 0%, #b91c1c 100%);
        box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4);
      }

      .start-btn:hover,
      .edit-questions-btn:hover {
        transform: scale(1.05);
        filter: brightness(1.2);
      }

      .questions-editor {
        display: none;
        max-height: 70vh;
        overflow-y: auto;
        margin: 20px 0;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
        border-top: 1px solid #475569;
        padding-top: 20px;
      }

      .question-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(325px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .question-item {
        background: #334155;
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #6366f1;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }

      .question-item h4 {
        color: #818cf8;
        margin-bottom: 15px;
        font-size: 1.1em;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 2px solid #475569;
      }

      .question-item .label-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .question-item .label-field {
        margin-bottom: 10px;
      }

      .question-item .label-field label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #cbd5e1;
        font-size: 0.9em;
      }

      .question-item .label-field input {
        width: 100%;
        padding: 8px;
        border: 1px solid #6366f1;
        background: #1e293b;
        color: white;
        border-radius: 8px;
        font-size: 0.9em;
      }

      .question-item .answers-field {
        margin-top: 15px;
      }

      .question-item .answers-field label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #cbd5e1;
        font-size: 0.9em;
      }

      .question-item textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #2ecc71;
        background: #1e293b;
        color: white;
        border-radius: 8px;
        font-size: 0.9em;
        min-height: 80px;
        resize: vertical;
      }

      .editor-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .save-btn,
      .cancel-edit-btn,
      .reset-default-btn {
        padding: 12px 30px;
        font-size: 1.1em;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
      }

      .save-btn {
        background: #10b981;
        color: white;
      }

      .cancel-edit-btn {
        background: #64748b;
        color: white;
      }

      .reset-default-btn {
        background: #ef4444;
        color: white;
      }

      .game-screen {
        display: none;
      }

      .game-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .current-player {
        font-size: 1.3em;
        font-weight: bold;
        color: #e2e8f0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .player-indicator {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: inline-block;
        border: 2px solid #e2e8f0;
      }

      .reset-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 30px;
        font-size: 1.1em;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .reset-btn:hover {
        background: #dc2626;
      }

      .game-board-container {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        justify-content: center;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }

      .board-column {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }

      .board-and-indicators {
        display: flex;
        flex-direction: column;
        width: fit-content;
      }

      .x-labels-container {
        display: grid;
        grid-template-columns: repeat(6, 90px);
        gap: 10px;
        margin-top: 10px;
      }

      /* Dark Labels */
      .x-label {
        background: #334155;
        padding: 10px 5px;
        border-radius: 10px;
        font-weight: bold;
        color: #e2e8f0;
        text-align: center;
        border: 1px solid #6366f1;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
      }

      .y-labels {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 50px;
      }

      .y-label {
        background: #334155;
        padding: 10px;
        border-radius: 10px;
        font-weight: bold;
        color: #e2e8f0;
        text-align: center;
        height: 90px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #8b5cf6;
        min-width: 140px;
        font-size: 0.85em;
      }

      /* The Game Board - Darker Grid */
      .board {
        display: grid;
        grid-template-columns: repeat(6, 90px);
        grid-template-rows: repeat(6, 90px);
        gap: 10px;
        background: #0f172a; /* Very dark blue/black */
        padding: 15px;
        border-radius: 15px;
        border: 4px solid #334155;
      }

      .cell {
        background: #1e293b; /* Empty cell color */
        border-radius: 50%;
        transition: all 0.3s;
        border: 2px solid #334155;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.8em;
        color: #333;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
      }

      .cell.filled {
        cursor: not-allowed;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.2);
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      }

      .cell.falling {
        animation: dropDown 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
      }

      @keyframes dropDown {
        0% {
          transform: translateY(-600px) scale(0.8);
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
        70% {
          transform: translateY(0px) scale(1.1);
        }
        85% {
          transform: translateY(-15px) scale(0.95);
        }
        100% {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .column-indicator {
        background: rgba(99, 102, 241, 0.2);
        border-radius: 10px 10px 0 0;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #818cf8;
        height: 30px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      .column-indicator:hover {
        background: rgba(99, 102, 241, 0.5);
        transform: scale(1.1);
      }

      .column-indicators {
        display: grid;
        grid-template-columns: repeat(6, 90px);
        gap: 10px;
        margin-bottom: 5px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85); /* Darker overlay */
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
      }

      .modal-content {
        background: #1e293b; /* Dark modal */
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid #475569;
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
      }

      .modal-content h2 {
        color: #818cf8;
        margin-bottom: 20px;
        font-size: 1.8em;
      }

      .modal-content p {
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #e2e8f0;
        white-space: pre-line;
      }

      .answer-input {
        width: 100%;
        padding: 15px;
        font-size: 1.1em;
        border: 2px solid #6366f1;
        background: #0f172a;
        color: white;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
      }

      .answer-input::placeholder {
        color: #64748b;
      }

      .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .submit-btn,
      .cancel-btn {
        padding: 12px 30px;
        font-size: 1.1em;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
      }

      .submit-btn {
        background: #10b981;
        color: white;
      }

      .submit-btn:hover {
        background: #059669;
      }

      .cancel-btn {
        background: #64748b;
        color: white;
      }

      .cancel-btn:hover {
        background: #475569;
      }

      .winner-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        justify-content: center;
        align-items: center;
        z-index: 2000;
        padding: 20px;
        overflow-y: auto;
      }

      .winner-content {
        background: #1e293b;
        padding: 50px;
        border-radius: 20px;
        text-align: center;
        animation: bounce 0.5s;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        border: 2px solid #f59e0b;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .winner-content h2 {
        color: #f59e0b;
        font-size: 3em;
        margin-bottom: 20px;
      }

      .winner-content .winner-color {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin: 20px auto;
        border: 5px solid #e2e8f0;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
      }

      .play-again-btn {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        border: none;
        padding: 15px 50px;
        font-size: 1.3em;
        border-radius: 50px;
        cursor: pointer;
        margin-top: 20px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        h1 {
          font-size: 1.5em;
          margin-bottom: 5px;
        }

        .subtitle {
          font-size: 0.9em;
          margin-bottom: 20px;
        }

        .labels-section {
          grid-template-columns: 1fr;
        }

        .player-count label {
          font-size: 1em;
        }

        .player-count select {
          padding: 8px 15px;
          font-size: 1em;
        }

        .player-card {
          min-width: 150px;
          padding: 15px;
        }

        .player-card h3 {
          font-size: 1em;
        }

        .start-btn,
        .edit-questions-btn {
          padding: 12px 25px;
          font-size: 1em;
        }

        .game-info {
          flex-direction: column;
          gap: 10px;
          margin-bottom: 15px;
        }

        .current-player {
          font-size: 1em;
        }

        .reset-btn {
          padding: 8px 20px;
          font-size: 1em;
        }

        .game-board-container {
          flex-direction: column;
          gap: 10px;
          overflow-x: auto;
          align-items: center;
        }

        .y-labels {
          flex-direction: row;
          margin-top: 0;
          margin-bottom: 10px;
          overflow-x: auto;
          width: 100%;
          max-width: fit-content;
          -webkit-overflow-scrolling: touch;
        }

        .y-label {
          min-width: 50px;
          width: 50px;
          height: 50px;
          font-size: 0.65em;
          padding: 5px;
          flex-shrink: 0;
        }

        .board {
          grid-template-columns: repeat(6, 50px);
          grid-template-rows: repeat(6, 50px);
          gap: 6px;
          padding: 10px;
          margin: 0 auto;
        }

        .board-column {
          width: fit-content;
          margin: 0 auto;
        }

        .column-indicators,
        .x-labels-container {
          grid-template-columns: repeat(6, 50px);
          gap: 6px;
          width: fit-content;
        }

        .column-indicator {
          height: 25px;
          font-size: 0.8em;
        }

        .x-label {
          font-size: 0.65em;
          padding: 5px;
          height: 40px;
        }

        .cell {
          font-size: 0.65em;
        }

        .modal-content {
          padding: 25px;
          width: 95%;
        }

        .modal-content h2 {
          font-size: 1.4em;
        }

        .modal-content p {
          font-size: 1em;
        }

        .answer-input {
          padding: 12px;
          font-size: 1em;
        }

        .submit-btn,
        .cancel-btn {
          padding: 10px 20px;
          font-size: 1em;
        }

        .winner-content {
          padding: 30px 20px;
        }

        .winner-content h2 {
          font-size: 2em;
        }

        .winner-content .winner-color {
          width: 80px;
          height: 80px;
        }

        .play-again-btn {
          padding: 12px 35px;
          font-size: 1.1em;
        }

        .questions-editor {
          max-height: 60vh;
        }

        .question-grid {
          grid-template-columns: 1fr;
        }

        .question-item {
          padding: 15px;
        }

        .question-item h4 {
          font-size: 0.95em;
        }

        .question-item .label-row {
          grid-template-columns: 1fr;
        }

        .question-item textarea {
          font-size: 0.85em;
          min-height: 60px;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 10px;
        }

        h1 {
          font-size: 1.2em;
        }

        .subtitle {
          font-size: 0.8em;
        }

        .board {
          grid-template-columns: repeat(6, 45px);
          grid-template-rows: repeat(6, 45px);
          gap: 5px;
          padding: 8px;
          margin: 0 auto;
        }

        .board-column {
          width: fit-content;
          margin: 0 auto;
        }

        .column-indicators,
        .x-labels-container {
          grid-template-columns: repeat(6, 45px);
          gap: 5px;
          width: fit-content;
        }

        .y-label {
          min-width: 45px;
          width: 45px;
          height: 45px;
          font-size: 0.58em;
          flex-shrink: 0;
        }

        .x-label {
          font-size: 0.58em;
          height: 35px;
        }

        .cell {
          font-size: 0.6em;
        }

        .player-card {
          min-width: 140px;
        }

        .color-btn {
          width: 35px;
          height: 35px;
        }

        .modal-content {
          padding: 20px;
        }

        .modal-content h2 {
          font-size: 1.2em;
        }

        .modal-content p {
          font-size: 0.9em;
        }

        .answer-input {
          padding: 10px;
          font-size: 0.95em;
        }

        .winner-content {
          padding: 25px 15px;
        }

        .winner-content h2 {
          font-size: 1.5em;
        }

        .winner-content .winner-color {
          width: 60px;
          height: 60px;
        }

        .play-again-btn {
          padding: 10px 25px;
          font-size: 1em;
        }
      }

      @media (max-width: 768px) and (orientation: landscape) {
        body {
          padding: 10px;
        }

        .container {
          padding: 10px;
          max-height: 90vh;
          overflow-y: auto;
        }

        h1 {
          font-size: 1.3em;
          margin-bottom: 5px;
        }

        .subtitle {
          font-size: 0.85em;
          margin-bottom: 10px;
        }

        .game-info {
          margin-bottom: 10px;
        }

        .game-board-container {
          max-height: calc(90vh - 100px);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Chemical Connect 4</h1>
      <p class="subtitle">Connect 4 Chemistry Compounds!</p>

      <div class="setup-screen" id="setupScreen">
        <div class="player-count">
          <label for="playerCount">Number of Players:</label>
          <select id="playerCount">
            <option value="2">2 Players</option>
            <option value="3">3 Players</option>
            <option value="4">4 Players</option>
          </select>
        </div>

        <div class="players-config" id="playersConfig"></div>

        <div class="action-buttons">
          <button class="start-btn" onclick="startGame()">Start Game üöÄ</button>
          <button class="edit-questions-btn" onclick="toggleQuestionEditor()">
            Edit Grid & Questions üìù
          </button>
        </div>

        <div class="questions-editor" id="questionsEditor">
          <h2 style="color: #667eea; margin-bottom: 20px">
            Edit Grid Cells - Labels & Answers
          </h2>

          <p style="color: #666; margin-bottom: 20px">
            For each cell, edit the X-label (column), Y-label (row), and valid
            answers.<br />
            Answers should be separated by commas (e.g., H2SO4, sulfuric acid)
          </p>

          <div class="question-grid" id="questionGrid"></div>

          <div class="editor-buttons">
            <button class="save-btn" onclick="saveQuestions()">
              Save All Changes ‚úì
            </button>
            <button class="reset-default-btn" onclick="resetToDefault()">
              Reset to Default
            </button>
            <button class="cancel-edit-btn" onclick="toggleQuestionEditor()">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div class="game-screen" id="gameScreen">
        <div class="game-info">
          <div class="current-player">
            <span>Current Turn:</span>
            <span class="player-indicator" id="currentPlayerIndicator"></span>
            <span id="currentPlayerName"></span>
          </div>
          <button class="reset-btn" onclick="resetGame()">New Game</button>
        </div>

        <div class="game-board-container">
          <div class="y-labels" id="yLabels"></div>
          <div class="board-column">
            <div class="board-and-indicators">
              <div class="column-indicators" id="columnIndicators"></div>
              <div class="board" id="gameBoard"></div>
            </div>
            <div class="x-labels-container" id="xLabels"></div>
          </div>
        </div>
      </div>

      <div class="modal" id="answerModal">
        <div class="modal-content">
          <h2>Answer the Question</h2>
          <p id="questionText"></p>
          <input
            type="text"
            class="answer-input"
            id="answerInput"
            placeholder="Type your answer here..."
          />
          <div class="modal-buttons">
            <button class="submit-btn" onclick="submitAnswer()">
              Submit ‚úì
            </button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        </div>
      </div>

      <div class="winner-modal" id="winnerModal">
        <div class="winner-content">
          <h2>üéâ Congratulations! üéâ</h2>
          <p style="font-size: 1.5em; margin: 20px 0">Winner:</p>
          <div class="winner-color" id="winnerColor"></div>
          <p style="font-size: 1.3em" id="winnerName"></p>
          <button class="play-again-btn" onclick="resetGame()">
            Play Again
          </button>
        </div>
      </div>
    </div>

    <script>
      let gameAudioContext = null;

      const availableColors = [
        '#e74c3c',
        '#3498db',
        '#2ecc71',
        '#f39c12',
        '#9b59b6',
        '#1abc9c'
      ];

      // COLUMNS (Titrants)
      const defaultXCategories = [
        'KMnO4',
        'K2Cr2O7',
        'Ce(SO4)2',
        'I2',
        'KIO3',
        'KBrO3'
      ];

      // ROWS (Questions)
      // Row 0 is TOP (Hardest/Last), Row 5 is BOTTOM (Easiest/First)
      const defaultYCategories = [
        'Does this titrant face auto-decomposition?', // Row 0 (Top)
        'What is the application of', // Row 1
        'What is the color of', // Row 2
        'What is the type of indicator used with', // Row 3
        'What is the final reduction product of', // Row 4
        'Is this titrant considered a 1ry standard' // Row 5 (Bottom - First Question)
      ];

      // ANSWERS (Mapped to new reversed rows)
      const defaultAnswers = {
        // --- Column 0: KMnO4 ---
        '0-0': ['yes', 'light sensitive', 'mno2 catalyzes'], // Auto-decomp (Top)
        '0-1': [
          'redox titration',
          'iron determination',
          'oxalate',
          'hydrogen peroxide',
          'h2o2',
          'fe'
        ], // Application
        '0-2': ['purple', 'violet', 'deep purple'], // Color
        '0-3': ['self indicator', 'none', 'self', 'permanganate itself'], // Indicator
        '0-4': [
          'mn2+',
          'manganese(ii)',
          'mno2',
          'manganese dioxide',
          'mno4 2-',
          'manganate'
        ], // Reduction Product
        '0-5': ['no', 'secondary standard'], // 1ry Standard (Bottom)

        // --- Column 1: K2Cr2O7 ---
        '1-0': ['no', 'stable'], // Auto-decomp (Top)
        '1-1': [
          'cod',
          'chemical oxygen demand',
          'iron determination',
          'alcohol determination',
          'fe'
        ], // Application
        '1-2': ['orange', 'orange-red'], // Color
        '1-3': [
          'diphenylamine',
          'bds',
          'diphenylbenzidine',
          'redox indicator',
          'internal'
        ], // Indicator
        '1-4': ['cr3+', 'chromium(iii)', 'green ion'], // Reduction Product
        '1-5': ['yes', 'primary standard'], // 1ry Standard (Bottom)

        // --- Column 2: Ce(SO4)2 ---
        '2-0': ['no', 'stable', 'very stable'], // Auto-decomp (Top)
        '2-1': ['redox titration', 'drug analysis', 'paracetamol'], // Application
        '2-2': ['yellow', 'orange-yellow'], // Color
        '2-3': ['ferroin', 'n-phenylanthranilic acid'], // Indicator
        '2-4': ['ce3+', 'cerium(iii)', 'colorless'], // Reduction Product
        '2-5': ['no', 'secondary standard', 'usually standardized'], // 1ry Standard (Bottom)

        // --- Column 3: I2 ---
        '3-0': ['yes', 'volatile', 'sublimes', 'disproportionates in base'], // Auto-decomp (Top)
        '3-1': ['iodimetry', 'vitamin c', 'ascorbic acid', 'sulfides'], // Application
        '3-2': ['brown', 'red-brown', 'violet vapor'], // Color
        '3-3': ['starch', 'starch mucilage'], // Indicator
        '3-4': ['i-', 'iodide'], // Reduction Product
        '3-5': ['no', 'secondary standard', 'volatile'], // 1ry Standard (Bottom)

        // --- Column 4: KIO3 ---
        '4-0': ['no', 'stable'], // Auto-decomp (Top)
        '4-1': [
          'andrews titration',
          'iodine source',
          'standardizing thiosulfate'
        ], // Application
        '4-2': ['colorless', 'white solid'], // Color
        '4-3': ['starch', 'chloroform', 'ccl4', 'extraction'], // Indicator
        '4-4': ['i2', 'i-', 'i+'], // Reduction Product
        '4-5': ['yes', 'primary standard'], // 1ry Standard (Bottom)

        // --- Column 5: KBrO3 ---
        '5-0': ['no', 'stable'], // Auto-decomp (Top)
        '5-1': ['mg+2', 'al+3', 'phenol'], // Application
        '5-2': ['colorless', 'white solid'], // Color
        '5-3': [
          'methyl orange',
          'methyl red',
          'naphthol blue black',
          'irreversible'
        ], // Indicator
        '5-4': ['br-', 'bromide'], // Reduction Product
        '5-5': ['yes', 'primary standard'] // 1ry Standard (Bottom)
      };
      let xCategories = [];
      let yCategories = [];
      let validAnswers = {};
      let players = [];
      let currentPlayerIndex = 0;
      let board = Array(6)
        .fill(null)
        .map(() => Array(6).fill(null));
      let selectedColumn = null;

      function loadData() {
        const savedX = localStorage.getItem('chemConnect4XLabels');
        const savedY = localStorage.getItem('chemConnect4YLabels');
        const savedAnswers = localStorage.getItem('chemConnect4Answers');

        xCategories = savedX ? JSON.parse(savedX) : [...defaultXCategories];
        yCategories = savedY ? JSON.parse(savedY) : [...defaultYCategories];
        validAnswers = savedAnswers
          ? JSON.parse(savedAnswers)
          : JSON.parse(JSON.stringify(defaultAnswers));

        console.log('Loaded data:', { xCategories, yCategories, validAnswers });
      }

      function saveData() {
        localStorage.setItem(
          'chemConnect4XLabels',
          JSON.stringify(xCategories)
        );
        localStorage.setItem(
          'chemConnect4YLabels',
          JSON.stringify(yCategories)
        );
        localStorage.setItem(
          'chemConnect4Answers',
          JSON.stringify(validAnswers)
        );
        console.log('Saved data:', { xCategories, yCategories, validAnswers });
      }

      loadData();

      function initPlayerSetup() {
        const playerCount = parseInt(
          document.getElementById('playerCount').value
        );
        const container = document.getElementById('playersConfig');
        container.innerHTML = '';
        players = [];

        for (let i = 0; i < playerCount; i++) {
          const card = document.createElement('div');
          card.className = 'player-card';
          card.innerHTML = `
                    <h3>Player ${i + 1}</h3>
                    <input type="text" class="player-name-input" id="playerName${i}" placeholder="Enter name..." value="Player ${
            i + 1
          }">
                    <div class="color-options" id="colorOptions${i}">
                        ${availableColors
                          .map(
                            (color) => `
                            <div class="color-btn" style="background: ${color}"
                                 data-color="${color}"
                                 onclick="selectColor(${i}, '${color}')"></div>
                        `
                          )
                          .join('')}
                    </div>
                `;
          container.appendChild(card);
        }

        for (let i = 0; i < playerCount; i++) {
          selectColor(i, availableColors[i]);
        }
      }

      function selectColor(playerIndex, color) {
        const colorTaken = players.some(
          (p) => p.id !== playerIndex && p.color === color
        );
        if (colorTaken) {
          alert('This color is already taken! Please choose another.');
          return;
        }

        const colorOptions = document.getElementById(
          `colorOptions${playerIndex}`
        );
        if (!colorOptions) return;

        colorOptions
          .querySelectorAll('.color-btn')
          .forEach((btn) => btn.classList.remove('selected'));

        const selectedBtn = colorOptions.querySelector(
          `[data-color="${color}"]`
        );
        if (selectedBtn) selectedBtn.classList.add('selected');

        const nameInput = document.getElementById(`playerName${playerIndex}`);
        const playerName = nameInput
          ? nameInput.value.trim() || `Player ${playerIndex + 1}`
          : `Player ${playerIndex + 1}`;

        const existingPlayerIndex = players.findIndex(
          (p) => p.id === playerIndex
        );
        if (existingPlayerIndex !== -1) {
          players[existingPlayerIndex].color = color;
          players[existingPlayerIndex].name = playerName;
        } else {
          players.push({ id: playerIndex, name: playerName, color: color });
        }
      }

      function toggleQuestionEditor() {
        const editor = document.getElementById('questionsEditor');
        const isVisible = editor.style.display === 'block';

        if (!isVisible) {
          renderQuestionEditor();
          editor.style.display = 'block';
        } else {
          editor.style.display = 'none';
        }
      }

      function renderQuestionEditor() {
        const grid = document.getElementById('questionGrid');
        grid.innerHTML = '';

        for (let x = 0; x < 6; x++) {
          for (let y = 0; y < 6; y++) {
            const key = `${x}-${y}`;
            const answers = validAnswers[key] || [];

            const item = document.createElement('div');
            item.className = 'question-item';
            item.innerHTML = `
                        <h4>Cell (${x}, ${y})</h4>
                        <div class="label-row">
                          <div class="label-field">
                            <label>X-Label (Column ${x}):</label>
                            <input type="text" id="xlabel-${x}-${y}" value="${
              xCategories[x]
            }">
                          </div>
                          <div class="label-field">
                            <label>Y-Label (Row ${y}):</label>
                            <input type="text" id="ylabel-${x}-${y}" value="${
              yCategories[y]
            }">
                          </div>
                        </div>
                        <div class="answers-field">
                          <label>Valid Answers:</label>
                          <textarea id="answers-${key}" placeholder="Enter answers separated by commas...">${answers.join(
              ', '
            )}</textarea>
                        </div>
                    `;
            grid.appendChild(item);
          }
        }
      }

      function saveQuestions() {
        // Collect X and Y labels from the first occurrence of each
        const newXCategories = [];
        const newYCategories = [];

        // Get X labels from row 0
        for (let x = 0; x < 6; x++) {
          const input = document.getElementById(`xlabel-${x}-0`);
          if (input) newXCategories[x] = input.value.trim();
        }

        // Get Y labels from column 0
        for (let y = 0; y < 6; y++) {
          const input = document.getElementById(`ylabel-0-${y}`);
          if (input) newYCategories[y] = input.value.trim();
        }

        // Validate that all labels are consistent across cells
        let inconsistent = false;
        for (let x = 0; x < 6; x++) {
          for (let y = 0; y < 6; y++) {
            const xInput = document.getElementById(`xlabel-${x}-${y}`);
            const yInput = document.getElementById(`ylabel-${x}-${y}`);
            if (xInput && xInput.value.trim() !== newXCategories[x]) {
              inconsistent = true;
            }
            if (yInput && yInput.value.trim() !== newYCategories[y]) {
              inconsistent = true;
            }
          }
        }

        if (inconsistent) {
          if (
            !confirm(
              'Warning: Some X or Y labels are inconsistent across cells. The labels from the first row/column will be used. Continue?'
            )
          ) {
            return;
          }
        }

        xCategories = newXCategories;
        yCategories = newYCategories;

        // Save answers
        for (let x = 0; x < 6; x++) {
          for (let y = 0; y < 6; y++) {
            const key = `${x}-${y}`;
            const textarea = document.getElementById(`answers-${key}`);
            if (textarea) {
              const value = textarea.value.trim();
              validAnswers[key] = value
                ? value
                    .split(',')
                    .map((a) => a.trim().toLowerCase())
                    .filter((a) => a.length > 0)
                : [];
            }
          }
        }

        saveData();
        alert('All changes saved successfully! ‚úì');
        toggleQuestionEditor();
      }

      function resetToDefault() {
        if (
          confirm(
            'Are you sure you want to reset everything to default values?'
          )
        ) {
          xCategories = [...defaultXCategories];
          yCategories = [...defaultYCategories];
          validAnswers = JSON.parse(JSON.stringify(defaultAnswers));
          saveData();
          renderQuestionEditor();
          alert('Reset to default values! ‚úì');
        }
      }

      function startGame() {
        // --- ADD THESE LINES TO UNLOCK AUDIO ---
        if (!gameAudioContext) {
          gameAudioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }
        if (gameAudioContext.state === 'suspended') {
          gameAudioContext.resume();
        }

        const playerCount = parseInt(
          document.getElementById('playerCount').value
        );

        for (let i = 0; i < playerCount; i++) {
          const nameInput = document.getElementById(`playerName${i}`);
          const playerName = nameInput
            ? nameInput.value.trim() || `Player ${i + 1}`
            : `Player ${i + 1}`;
          const player = players.find((p) => p.id === i);
          if (player) player.name = playerName;
        }

        if (players.length !== playerCount) {
          alert('Please select colors for all players');
          return;
        }

        players.sort((a, b) => a.id - b.id);
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        initGame();
      }

      function initGame() {
        board = Array(6)
          .fill(null)
          .map(() => Array(6).fill(null));
        currentPlayerIndex = 0;

        const boardElement = document.getElementById('gameBoard');
        boardElement.innerHTML = '';

        for (let y = 0; y < 6; y++) {
          for (let x = 0; x < 6; x++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.setAttribute('data-x', x);
            cell.setAttribute('data-y', y);
            boardElement.appendChild(cell);
          }
        }

        const indicatorsElement = document.getElementById('columnIndicators');
        indicatorsElement.innerHTML = '';
        for (let x = 0; x < 6; x++) {
          const indicator = document.createElement('div');
          indicator.className = 'column-indicator';
          indicator.textContent = '‚ñº';
          indicator.onclick = () => dropPiece(x);
          indicatorsElement.appendChild(indicator);
        }

        document.getElementById('xLabels').innerHTML = xCategories
          .map((cat) => `<div class="x-label">${cat}</div>`)
          .join('');
        document.getElementById('yLabels').innerHTML = yCategories
          .map((cat) => `<div class="y-label">${cat}</div>`)
          .join('');

        updateCurrentPlayer();
      }

      function updateCurrentPlayer() {
        const player = players[currentPlayerIndex];
        document.getElementById('currentPlayerIndicator').style.background =
          player.color;
        document.getElementById('currentPlayerName').textContent = player.name;
      }

      function dropPiece(column) {
        let targetRow = -1;
        for (let y = 5; y >= 0; y--) {
          if (board[y][column] === null) {
            targetRow = y;
            break;
          }
        }

        if (targetRow === -1) {
          alert('This column is full! Choose another column.');
          return;
        }

        selectedColumn = { x: column, y: targetRow };

        const xCat = xCategories[column];
        const yCat = yCategories[targetRow];

        // This formats the text to look like a clean Question Card
        const questionText = document.getElementById('questionText');

        // We add a question mark (?) automatically if the text doesn't have one
        const questionEnding = yCat.trim().endsWith('?') ? '' : '?';

        // This sets the text to:
        // "Topic: KMnO4"
        // "What is the color of?"
        questionText.innerText = `Topic: ${xCat}\n\n${yCat}${questionEnding}`;

        document.getElementById('answerInput').value = '';
        document.getElementById('answerModal').style.display = 'flex';
        document.getElementById('answerInput').focus();
      }

      function submitAnswer() {
        if (gameAudioContext && gameAudioContext.state === 'suspended') {
          gameAudioContext.resume();
        }

        if (!selectedColumn) return;

        const answer = document
          .getElementById('answerInput')
          .value.trim()
          .toLowerCase();

        if (answer === '') {
          alert('Please enter an answer!');
          return;
        }

        const targetCell = { x: selectedColumn.x, y: selectedColumn.y };
        const key = `${targetCell.x}-${targetCell.y}`;
        const validAnswersForCell = validAnswers[key] || [];

        let isCorrect = false;

        if (validAnswersForCell.length === 0) {
          isCorrect = true;
        } else {
          for (let validAnswer of validAnswersForCell) {
            const validLower = validAnswer.toLowerCase().trim();

            if (answer === validLower) {
              isCorrect = true;
              break;
            }
          }
        }

        closeModal();

        if (isCorrect) {
          const player = players[currentPlayerIndex];
          board[targetCell.y][targetCell.x] = currentPlayerIndex;

          const cellElement = document.querySelector(
            `#gameBoard [data-x="${targetCell.x}"][data-y="${targetCell.y}"]`
          );
          if (!cellElement) return;

          cellElement.classList.add('falling');
          cellElement.style.background = player.color;
          cellElement.classList.add('filled');
          // Show the User's answer inside the bubble
          cellElement.textContent = answer.toUpperCase().substring(0, 6);
          cellElement.style.color = 'white';
          cellElement.style.fontWeight = 'bold';

          setTimeout(() => {
            cellElement.classList.remove('falling');

            if (checkWinner(targetCell.x, targetCell.y)) {
              setTimeout(() => showWinner(), 300);
              return;
            }

            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            updateCurrentPlayer();
          }, 800);
        } else {
          alert('Wrong answer! Moving to next player.');
          currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
          updateCurrentPlayer();
        }
      }

      function closeModal() {
        document.getElementById('answerModal').style.display = 'none';
        selectedColumn = null;
      }

      function checkWinner(lastX, lastY) {
        const player = currentPlayerIndex;

        let count = 1;
        for (let x = lastX - 1; x >= 0; x--) {
          if (board[lastY][x] === player) count++;
          else break;
        }
        for (let x = lastX + 1; x < 6; x++) {
          if (board[lastY][x] === player) count++;
          else break;
        }
        if (count >= 4) return true;

        count = 1;
        for (let y = lastY - 1; y >= 0; y--) {
          if (board[y][lastX] === player) count++;
          else break;
        }
        for (let y = lastY + 1; y < 6; y++) {
          if (board[y][lastX] === player) count++;
          else break;
        }
        if (count >= 4) return true;

        count = 1;
        for (let i = 1; lastX - i >= 0 && lastY - i >= 0; i++) {
          if (board[lastY - i][lastX - i] === player) count++;
          else break;
        }
        for (let i = 1; lastX + i < 6 && lastY + i < 6; i++) {
          if (board[lastY + i][lastX + i] === player) count++;
          else break;
        }
        if (count >= 4) return true;

        count = 1;
        for (let i = 1; lastX + i < 6 && lastY - i >= 0; i++) {
          if (board[lastY - i][lastX + i] === player) count++;
          else break;
        }
        for (let i = 1; lastX - i >= 0 && lastY + i < 6; i++) {
          if (board[lastY + i][lastX - i] === player) count++;
          else break;
        }
        if (count >= 4) return true;

        return false;
      }

      function showWinner() {
        const player = players[currentPlayerIndex];
        document.getElementById('winnerColor').style.background = player.color;
        document.getElementById('winnerName').textContent = player.name;
        document.getElementById('winnerModal').style.display = 'flex';

        playWinSound();
      }

      function resetGame() {
        document.getElementById('winnerModal').style.display = 'none';
        document.getElementById('setupScreen').style.display = 'block';
        document.getElementById('gameScreen').style.display = 'none';
        players = [];
        initPlayerSetup();
      }

      function playWinSound() {
        // If audio setup failed or isn't supported, stop
        if (!gameAudioContext) return;

        // Create the sequence
        const now = gameAudioContext.currentTime;

        // Notes: C5, E5, G5, C6 (Victory Arpeggio)
        const notes = [523.25, 659.25, 783.99, 1046.5];

        notes.forEach((freq, i) => {
          const osc = gameAudioContext.createOscillator();
          const gain = gameAudioContext.createGain();

          osc.type = 'triangle'; // Retro game sound
          osc.frequency.value = freq;

          // Connect oscillator -> gain -> speakers
          osc.connect(gain);
          gain.connect(gameAudioContext.destination);

          // Timing: Play one note after another (0.1s apart)
          const startTime = now + i * 0.1;
          const duration = 0.1;

          // Volume: Start loud, fade to silence
          gain.gain.setValueAtTime(0.2, startTime);
          gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

          osc.start(startTime);
          osc.stop(startTime + duration);
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        initPlayerSetup();
        document
          .getElementById('answerInput')
          .addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitAnswer();
          });
        document
          .getElementById('playerCount')
          .addEventListener('change', initPlayerSetup);
      });
    </script>
  </body>
</html>
